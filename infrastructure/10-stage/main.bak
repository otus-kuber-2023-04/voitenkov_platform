resource "yandex_vpc_address" "ip-otus-kuber-dev-k8s-ingress" {
  name = "ip-${var.project}-${var.environment}-k8s-ingress"

  external_ipv4_address {
    zone_id = "ru-central1-a"
  }
}

resource "yandex_dns_recordset" "r1-dns-rs-otus-kuber-dev" {
  zone_id = yandex_dns_zone.z1-dns-zone-otus-kuber.id
  name    = "*.${var.subdomain1_1}.${var.domain1}."
  type    = "A"
  ttl     = 600
  data    = ["${yandex_vpc_address.ip-otus-kuber-dev-k8s-ingress.external_ipv4_address.0.address}"]
}

resource "yandex_dns_recordset" "r1-dns-rs-otus-kuber-dev" {
  zone_id = yandex_dns_zone.z1-dns-zone-otus-kuber.id
  name    = "*.${var.subdomain1_1}.${var.domain1}."
  type    = "A"
  ttl     = 600
  data    = ["${var.external_ip1}"]

  depends_on = [yandex_dns_zone.z1-dns-zone-otus-kuber]
}



resource "yandex_dns_zone" "z1-dns-zone-otus-kuber" {
  name        = "dns-zone-${var.project}-1"
  description = "DNS zone for ${var.domain1} domain"
  zone        = "${var.domain1}."
  public      = true
}

resource "yandex_dns_recordset" "r1-dns-rs-otus-kuber-stage" {
  zone_id = yandex_dns_zone.z1-dns-zone-otus-kuber.id
  name    = "*.${var.subdomain1_1}.${var.domain1}."
  type    = "A"
  ttl     = 600
  data    = ["${var.external_ip1}"]

  depends_on = [yandex_dns_zone.z1-dns-zone-otus-kuber]
}

module "security-events-to-siem-importer" {
  source                         = "../modules/auditlogs-k8s-ELK"
  folder_id                      = var.folder_id
  cloud_id                       = var.cloud_id
  cluster_name                   = var.cluster_name
  elastic_server                 = var.elastic_server
  elastic_pw                     = var.elastic_pw
  elastic_user                   = var.elastic_user
  service_account_id             = yandex_iam_service_account.sa-otus-kuber-stage-auditlogs.id
  log_bucket_name                = var.log_bucket_name
  create_namespace               = var.create_namespace
  worker_docker_image            = var.worker_docker_image
  auditlog_enabled               = var.auditlog_enabled
  auditlogs_prefix               = var.auditlogs_prefix
  auditlog_worker_chart_name     = var.auditlog_worker_chart_name
  auditlog_worker_namespace      = var.auditlog_worker_namespace
  auditlog_worker_replicas_count = var.auditlog_worker_replicas_count
  falco_enabled                  = var.falco_enabled
  falco_prefix                   = var.falco_prefix
  falco_worker_chart_name        = var.falco_worker_chart_name
  falco_worker_namespace         = var.falco_worker_namespace
  falco_worker_replicas_count    = var.falco_worker_replicas_count
  falco_helm_namespace           = var.falco_helm_namespace
  falco_version                  = var.falco_version
  falcosidekick_version          = var.falcosidekick_version
  kyverno_enabled                = var.kyverno_enabled
  kyverno_prefix                 = var.kyverno_prefix
  kyverno_version                = var.kyverno_version
  kyverno_worker_chart_name      = var.kyverno_worker_chart_name
  kyverno_worker_namespace       = var.kyverno_worker_namespace
  kyverno_worker_replicas_count  = var.kyverno_worker_replicas_count
  kyverno_helm_namespace         = var.kyverno_helm_namespace
  kyverno_policies_version       = var.kyverno_policies_version
  policy_reporter_version        = var.policy_reporter_version
  fakeeventgenerator_enabled     = var.fakeeventgenerator_enabled
}